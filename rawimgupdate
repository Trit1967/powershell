# CONFIGURE THIS --
$CsvPath = '\\YourServer\Share\rawimage_versions.csv'

# Gather machine info
$MachineName = $env:COMPUTERNAME
$Timestamp   = Get-Date -Format 's'

# Detect Store-installed extension
$pkg = Get-AppxPackage -AllUsers |
       Where-Object { $_.Name -like '*RawImageExtension*' }
$AppxVersion = if ($null -ne $pkg) { $pkg.Version.ToString() } else { '' }

# Detect FOD capability entries
$capEntries = Get-WindowsCapability -Online |
              Where-Object { $_.Name -like 'Microsoft.Windows.RawImageExtension*' }

$CapabilityVersion = ''
$CapabilityState   = ''

if ($capEntries.Count -gt 0) {
    $firstCap = $capEntries[0]
    $CapabilityVersion = ($firstCap.Name -split '~~~~')[1]
    $CapabilityState   = $firstCap.State

    foreach ($cap in $capEntries) {
        try {
            Add-WindowsCapability -Online -Name $cap.Name -ErrorAction Stop | Out-Null
            Write-Host "FOD refreshed: $($cap.Name)"
        }
        catch {
            Write-Warning "Failed to refresh FOD $($cap.Name): $_"
        }
    }
}

# Final installed check
$capInstalled = Get-WindowsCapability -Online |
                Where-Object { $_.Name -like 'Microsoft.Windows.RawImageExtension*' -and $_.State -eq 'Installed' }
$Installed    = if ($pkg -or $capInstalled) { 'Yes' } else { 'No' }

# Build CSV record
$Record = [PSCustomObject]@{
    MachineName       = $MachineName
    Timestamp         = $Timestamp
    AppxVersion       = $AppxVersion
    CapabilityVersion = $CapabilityVersion
    CapabilityState   = $CapabilityState
    Installed         = $Installed
}

# Ensure folder exists
$Folder = Split-Path $CsvPath -Parent
if (-not (Test-Path $Folder)) {
    New-Item -Path $Folder -ItemType Directory -Force | Out-Null
}

# Export or append
if (-not (Test-Path $CsvPath)) {
    $Record | Export-Csv -Path $CsvPath -NoTypeInformation -Force
}
else {
    $Record | Export-Csv -Path $CsvPath -NoTypeInformation -Append
}

Write-Host "`nRecorded Raw Image Extension info (Installed=$Installed) to $CsvPath"
