# ——— CONFIGURE THIS ———
# UNC path (including filename) where all machines will append their report
$CsvPath = '\\YourServer\Share\rawimage_versions.csv'
# —————————————————————

# Gather machine info
$MachineName = $env:COMPUTERNAME
$Timestamp   = (Get-Date).ToString('s')

# Detect Store-installed extension
$pkg = Get-AppxPackage -AllUsers | Where-Object Name -like '*RawImageExtension*'
$AppxVersion = if ($pkg) { $pkg.Version.ToString() } else { '' }

# Detect Features-on-Demand capability
$cap = Get-WindowsCapability -Online | Where-Object Name -like 'Microsoft.Windows.RawImageExtension*'
if ($cap) {
    $Parts               = $cap.Name -split '~~~~'
    $CapabilityVersion   = $Parts[1]
    $CapabilityState     = $cap.State
} else {
    $CapabilityVersion   = ''
    $CapabilityState     = ''
}

# Attempt uninstallation
$uninstalled = $false

if ($pkg) {
    try {
        Remove-AppxPackage -Package $pkg.PackageFullName -AllUsers -ErrorAction Stop
        $uninstalled = $true
    } catch {
        Write-Warning "Failed to uninstall Appx extension: $_"
    }
}

if ($cap) {
    try {
        Remove-WindowsCapability -Online -Name $cap.Name -ErrorAction Stop
        $uninstalled = $true
    } catch {
        Write-Warning "Failed to uninstall Capability: $_"
    }
}

$UninstalledStatus = if ($uninstalled) { 'Yes' } else { 'No' }

# Build the record for CSV
$Record = [PSCustomObject]@{
    MachineName        = $MachineName
    Timestamp          = $Timestamp
    AppxVersion        = $AppxVersion
    CapabilityVersion  = $CapabilityVersion
    CapabilityState    = $CapabilityState
    Uninstalled        = $UninstalledStatus
}

# Ensure the share’s folder exists
$Folder = Split-Path $CsvPath
if (-not (Test-Path $Folder)) {
    New-Item -Path $Folder -ItemType Directory -Force | Out-Null
}

# Export or append to CSV
if (-not (Test-Path $CsvPath)) {
    $Record | Export-Csv -Path $CsvPath -NoTypeInformation
} else {
    $Record | Export-Csv -Path $CsvPath -NoTypeInformation -Append
}

Write-Host "Recorded Raw Image Extension info (Uninstalled=$UninstalledStatus) to $CsvPath"
